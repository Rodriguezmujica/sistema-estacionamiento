# ‚úÖ Checklist Para Probar Integraci√≥n TUU Ma√±ana

**Fecha de creaci√≥n:** 11 de Octubre, 2025  
**Objetivo:** Probar la integraci√≥n real con las m√°quinas TUU

---

## üìã ANTES DE EMPEZAR

### **Lo que YA tienes configurado:** ‚úÖ

| Item | Estado | Valor Actual |
|------|--------|--------------|
| **API Key** | ‚úÖ Configurada | `uIAwXISF5...` |
| **Device Serial Principal** | ‚úÖ Configurado | `57964` |
| **URL API** | ‚úÖ Correcta | `RemotePayment/v2/Create` |
| **Modo Prueba** | ‚úÖ Activo | `true` |
| **Sistema Emergencia** | ‚úÖ Funcional | Principal/Respaldo |
| **C√≥digo de Integraci√≥n** | ‚úÖ Completo | `tuu-pago.php` |

---

## üéØ LO QUE NECESITAS HACER MA√ëANA

### **Checklist en Orden de Prioridad:**

---

## 1Ô∏è‚É£ **PASO 1: Verificar Credenciales TUU** üîê

### A. Entrar al Panel de TUU
```
üåê URL: https://tuu.cl
üìß Usuario: Tu email de registro
üîë Contrase√±a: Tu contrase√±a
```

### B. Verificar API Key
**Ubicaci√≥n en panel TUU:**
- Configuraci√≥n ‚Üí API ‚Üí Keys
- O: Settings ‚Üí Workspace ‚Üí API Key

**¬øQu√© verificar?**
- [ ] La API Key que tienes en el c√≥digo (`uIAwXISF5...`) es la correcta
- [ ] La API Key est√° activa (no vencida ni revocada)
- [ ] Tienes permisos de "Crear Pagos Remotos"

**Si la API Key est√° mal o vencida:**
```php
// Editar archivo: api/tuu-pago.php
// L√≠nea 19:
define('TUU_API_KEY', 'TU_NUEVA_API_KEY_AQUI');
```

---

## 2Ô∏è‚É£ **PASO 2: Configurar Device Serial de Respaldo** üì±

### A. Prender la M√°quina 2
- [ ] Conectar a corriente
- [ ] Encender dispositivo
- [ ] Esperar que termine de cargar

### B. Obtener el Device Serial
**Opci√≥n 1: Panel TUU**
```
1. Ir a: Dispositivos ‚Üí Mis Dispositivos
2. Buscar la segunda m√°quina
3. Copiar el "Serial Number" o "Device ID"
```

**Opci√≥n 2: En el Dispositivo**
```
1. Buscar etiqueta f√≠sica en la m√°quina
2. Buscar "Serial" o "Device ID"
3. Copiar el n√∫mero
```

### C. Actualizar en el Sistema
**M√©todo F√°cil:**
```
1. Editar: sql/actualizar_serial_respaldo_MANANA.php
2. Cambiar l√≠nea 14:
   $nuevoSerial = 'SERIAL_REAL_AQUI';
3. Abrir en navegador:
   http://localhost:8080/sistemaEstacionamiento/sql/actualizar_serial_respaldo_MANANA.php
```

**O SQL directo:**
```sql
UPDATE configuracion_tuu 
SET device_serial = 'SERIAL_MAQUINA_2' 
WHERE maquina = 'respaldo';
```

---

## 3Ô∏è‚É£ **PASO 3: Verificar Conectividad** üåê

### A. Verificar Red
- [ ] Las m√°quinas TUU est√°n conectadas a Internet
- [ ] Pueden alcanzar: `integrations.payment.haulmer.com`
- [ ] No hay firewall bloqueando

**Test de Conectividad:**
```bash
# Desde CMD/PowerShell:
ping integrations.payment.haulmer.com
```

### B. Verificar Permiso de API
- [ ] El Workspace tiene activado "Pago Remoto"
- [ ] La API Key tiene permisos para crear pagos
- [ ] Los dispositivos est√°n asociados al Workspace

---

## 4Ô∏è‚É£ **PASO 4: Hacer Prueba en MODO TEST** üß™

### A. Mantener Modo Prueba Activo
**Ubicaci√≥n:** `api/tuu-pago.php` l√≠nea 21
```php
define('TUU_MODO_PRUEBA', true); // ‚úÖ Mantener en true primero
```

**¬øPor qu√©?**
- ‚úÖ No se conecta a la m√°quina real
- ‚úÖ No genera boletas reales
- ‚úÖ Simula pagos exitosos
- ‚úÖ Puedes probar todo el flujo sin riesgo

### B. Probar el Flujo Completo
1. **Registrar un Ingreso:**
   - Patente de prueba: `TEST01`
   - Servicio: Estacionamiento por minuto
   
2. **Calcular Cobro:**
   - Buscar patente `TEST01`
   - Verificar que calcule el monto

3. **Probar Pago con TUU (Modo Prueba):**
   - Click en "Pagar con TUU"
   - Seleccionar m√©todo: Efectivo
   - El sistema simular√° pago exitoso
   - **Resultado esperado:** Registro en BD con `tipo_pago='tuu'`

4. **Verificar en Base de Datos:**
   ```sql
   SELECT * FROM salidas 
   WHERE patente = 'TEST01' 
   ORDER BY fecha_salida DESC 
   LIMIT 1;
   ```
   
   **Debe mostrar:**
   - `metodo_pago = 'TUU'`
   - `tipo_pago = 'tuu'`
   - `transaction_id = 'TUU-TEST-...'`
   - `authorization_code = 'AUTH...'`

---

## 5Ô∏è‚É£ **PASO 5: Activar MODO PRODUCCI√ìN** üöÄ

### ‚ö†Ô∏è **SOLO SI EL PASO 4 FUNCION√ì CORRECTAMENTE**

### A. Cambiar a Modo Producci√≥n
**Editar:** `api/tuu-pago.php` l√≠nea 21
```php
// ANTES:
define('TUU_MODO_PRUEBA', true);

// DESPU√âS:
define('TUU_MODO_PRUEBA', false); // ‚úÖ Modo producci√≥n
```

### B. Primera Prueba Real
**‚ö†Ô∏è Importante:** La primera prueba real generar√° una boleta oficial.

1. **Registrar un Ingreso de Prueba:**
   - Patente: `PRUEREAL`
   - Servicio: Estacionamiento por minuto
   - Esperar 5 minutos

2. **Calcular Cobro:**
   - Buscar `PRUEREAL`
   - Monto ser√° m√≠nimo (ej: $500)

3. **Pagar con TUU (REAL):**
   - Click en "Pagar con TUU"
   - **Seleccionar Efectivo** (m√°s f√°cil para prueba)
   - **Observar la M√°quina TUU:**
     - Debe mostrar el monto
     - Debe pedir confirmaci√≥n
     - Debe imprimir boleta

4. **Verificar Resultado:**
   - Sistema debe marcar como pagado
   - Boleta impresa en la m√°quina
   - Registro en BD con datos reales

---

## 6Ô∏è‚É£ **PASO 6: Probar Sistema de Emergencia** üö®

### A. Probar con M√°quina Principal
1. Hacer un cobro con m√°quina principal
2. Verificar que use serial `57964`

### B. Cambiar a M√°quina de Respaldo
1. Click en "Emergencia"
2. Cambiar a "Respaldo"
3. Hacer un cobro
4. Verificar que use el serial de respaldo

### C. Volver a Principal
1. Click en "Emergencia"
2. Cambiar a "Principal"
3. Verificar badge en navbar: üü¢ Principal

---

## 7Ô∏è‚É£ **PASO 7: Probar Diferentes Escenarios** üé≠

### A. Pago con Tarjeta de Cr√©dito
```
1. Registrar ingreso
2. Pagar con TUU ‚Üí Seleccionar "Cr√©dito"
3. Pasar tarjeta en m√°quina TUU
4. Verificar boleta y registro en BD
```

### B. Pago con Tarjeta de D√©bito
```
1. Registrar ingreso
2. Pagar con TUU ‚Üí Seleccionar "D√©bito"
3. Pasar tarjeta en m√°quina TUU
4. Verificar boleta y registro en BD
```

### C. Pago en Efectivo
```
1. Registrar ingreso
2. Pagar con TUU ‚Üí Seleccionar "Efectivo"
3. Confirmar en m√°quina TUU
4. Verificar boleta y registro en BD
```

### D. Factura (con RUT)
```
1. Registrar ingreso
2. Pagar con TUU
3. Seleccionar "Factura"
4. Ingresar RUT del cliente
5. TUU consultar√° datos en SII autom√°ticamente
6. Verificar factura impresa
```

### E. Error de Ingreso
```
1. Registrar "Error de Ingreso"
2. Intentar cobrar
3. Debe cobrar solo $1
4. Verificar que se registre correctamente
```

### F. Servicio de Lavado
```
1. Registrar servicio de lavado con "motivos extra"
2. Agregar precio extra
3. Pagar con TUU
4. Verificar que el total incluya precio base + extra
5. Verificar que motivos_extra se guarden en BD
```

---

## üõ†Ô∏è **TROUBLESHOOTING**

### Problema 1: "Error de Autenticaci√≥n"
**Causa:** API Key inv√°lida  
**Soluci√≥n:**
1. Verificar API Key en panel TUU
2. Copiar nueva API Key
3. Actualizar en `api/tuu-pago.php` l√≠nea 19

---

### Problema 2: "Device not found"
**Causa:** Device Serial incorrecto  
**Soluci√≥n:**
1. Verificar serial en panel TUU
2. Verificar serial en tabla `configuracion_tuu`
3. Actualizar si es necesario:
   ```sql
   UPDATE configuracion_tuu 
   SET device_serial = 'SERIAL_CORRECTO' 
   WHERE maquina = 'principal';
   ```

---

### Problema 3: "Timeout - M√°quina no responde"
**Causa:** M√°quina apagada o sin conexi√≥n  
**Soluci√≥n:**
1. Verificar que la m√°quina est√© encendida
2. Verificar conexi√≥n a Internet
3. Probar cambiar a m√°quina de respaldo:
   - Click en "Emergencia"
   - Cambiar a respaldo

---

### Problema 4: "Payment rejected"
**Causa:** Pago rechazado por el cliente o error en tarjeta  
**Soluci√≥n:**
1. Si es tarjeta: Verificar que tenga fondos
2. Si es d√©bito: Verificar que tenga saldo
3. Intentar con otro m√©todo de pago
4. O usar "Pago Manual" como fallback

---

### Problema 5: Boleta no imprime
**Causa:** Papel agotado o impresora con problema  
**Soluci√≥n:**
1. Verificar papel en la m√°quina TUU
2. Revisar estado de impresora en panel TUU
3. El pago YA est√° registrado, solo falta imprimir
4. Puedes reimprimir desde panel TUU

---

## üìä **VERIFICACI√ìN FINAL**

### Checklist de Verificaci√≥n Post-Prueba

#### ‚úÖ Credenciales
- [ ] API Key correcta y activa
- [ ] Device Serial Principal correcto (57964)
- [ ] Device Serial Respaldo configurado

#### ‚úÖ Conectividad
- [ ] M√°quinas TUU conectadas a Internet
- [ ] Sistema puede alcanzar API de TUU
- [ ] Sin errores de firewall

#### ‚úÖ Modo Producci√≥n
- [ ] `TUU_MODO_PRUEBA = false` (solo despu√©s de probar)
- [ ] Primera prueba real exitosa
- [ ] Boleta impresa correctamente

#### ‚úÖ Flujos de Pago
- [ ] Pago con Efectivo funciona
- [ ] Pago con Cr√©dito funciona
- [ ] Pago con D√©bito funciona
- [ ] Generaci√≥n de Factura funciona

#### ‚úÖ Sistema de Emergencia
- [ ] Cambio a m√°quina respaldo funciona
- [ ] Badge en navbar actualiza correctamente
- [ ] Pagos con respaldo funcionan
- [ ] Volver a principal funciona

#### ‚úÖ Casos Especiales
- [ ] Error de Ingreso ($1) funciona
- [ ] Lavados con precio extra funcionan
- [ ] Motivos extra se guardan correctamente

#### ‚úÖ Base de Datos
- [ ] Pagos TUU se guardan con `tipo_pago='tuu'`
- [ ] Transaction ID se guarda correctamente
- [ ] Authorization code se guarda
- [ ] M√©todo de pago se registra (efectivo/credito/debito)

---

## üéØ **RESUMEN: ¬øQu√© te falta?**

### **Para Modo Prueba (Hoy/Ma√±ana):**
‚úÖ Ya puedes probarlo ‚Üí Todo est√° configurado

### **Para Modo Producci√≥n (Ma√±ana):**
1. ‚è≥ **Configurar Device Serial de Respaldo** (cuando prendas m√°quina 2)
2. ‚ö†Ô∏è **Verificar API Key** (entrar al panel TUU y confirmar)
3. ‚ö†Ô∏è **Cambiar `TUU_MODO_PRUEBA = false`** (solo despu√©s de probar en test)
4. ‚úÖ **Hacer primera prueba real** (con efectivo, es m√°s f√°cil)

---

## üìû **Soporte Durante la Prueba**

### Si algo falla:

**1. Revisar logs de PHP:**
```
C:\xampp\apache\logs\error.log
```

**2. Revisar consola del navegador (F12):**
- Tab "Console" para errores JavaScript
- Tab "Network" para ver requests a TUU

**3. Usar Pago Manual como fallback:**
- Si TUU no responde
- Registrar pago manual
- Resolver despu√©s

**4. Contactar Soporte TUU:**
- Email: soporte@tuu.cl
- Tel√©fono: (verificar en su sitio)
- Chat en panel de TUU

---

## üìù **Log de Prueba (Para llenar ma√±ana)**

```
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
FECHA: ___/___/2025
HORA INICIO: _____
PERSONA QUE PRUEBA: _______________
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

‚úÖ PASO 1: Verificar Credenciales
   API Key v√°lida: [ ] S√≠ [ ] No
   Device Serial Principal: [ ] OK [ ] Falla
   Device Serial Respaldo: [ ] OK [ ] Pendiente

‚úÖ PASO 2: Modo Prueba
   Ingreso registrado: [ ] S√≠ [ ] No
   Cobro calculado: [ ] S√≠ [ ] No
   Pago TUU simulado: [ ] √âxito [ ] Falla
   
‚úÖ PASO 3: Modo Producci√≥n
   Cambio a producci√≥n: [ ] Hecho
   Primera prueba real: [ ] √âxito [ ] Falla
   Boleta impresa: [ ] S√≠ [ ] No
   
‚úÖ PASO 4: Tipos de Pago
   Efectivo: [ ] OK [ ] Falla
   Cr√©dito: [ ] OK [ ] Falla
   D√©bito: [ ] OK [ ] Falla
   Factura: [ ] OK [ ] No probado
   
‚úÖ PASO 5: Sistema Emergencia
   Cambio a respaldo: [ ] OK [ ] Falla
   Pago con respaldo: [ ] OK [ ] Falla
   Volver a principal: [ ] OK [ ] Falla

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
PROBLEMAS ENCONTRADOS:
___________________________________________________________
___________________________________________________________
___________________________________________________________

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
HORA FIN: _____
RESULTADO GENERAL: [ ] ‚úÖ TODO OK [ ] ‚ö†Ô∏è PROBLEMAS MENORES [ ] ‚ùå FALLAS CR√çTICAS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
```

---

## üéâ **¬°Listo para Probar!**

**Recuerda:**
1. ‚úÖ Empezar en modo PRUEBA
2. ‚úÖ Probar todos los flujos
3. ‚úÖ Solo entonces pasar a PRODUCCI√ìN
4. ‚úÖ Tener "Pago Manual" como fallback

**¬°Mucha suerte ma√±ana! üöÄ**

